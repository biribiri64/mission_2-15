<?php
/* MySQL データベースに接続する */
//データベース名：FTPアカウントの「-」と「.」を「_」に変更（例：co_000_99sv_coco_com）
//ホスト：localhost　ここは変更不要
$dsn = 'mysql:dbname=co_38_99sv_coco_com;host=localhost';
//ユーザー名：FTPアカウントの頭１６文字まで(例：co-000.99sv-cocoやco-999.it.99sv-c)
$user = 'co-38.99sv-coco.';
//パスワード：FTPアカウントのパスワード
$password = 'cdTen7';
//▲変更するのははここまで▲

$pdo = new PDO($dsn,$user,$password);

//ここからmission_2-8の内容

/* 文字コードをUTF-8にして文字化け対策 */
$stmt = $pdo->query('SET NAMES utf8');

/* SQLコマンド「CREATE TABLE」で新しくテーブルを作り、その中のカラム（項目）を決めておく */
$sql= "CREATE TABLE tbtest7"
."("
."id INT auto_increment primary key,"
."name TEXT,"
."comment TEXT,"
."time TEXT,"
."pass TEXT"
.");";

$stmt = $pdo->query($sql);
//PDOでINSERTを利用してカラムに値を代入する
if(!empty($_POST['user']) && ($_POST['message']) && ($_POST['pass'])){
$name = $_POST['user']; //名前を代入
$comment = $_POST['message']; //コメントを代入
$time = date("Y/m/d H:i:s"); //時間を代入
$pass = $_POST['pass']; //パスワードを代入

$sql = $pdo->prepare("INSERT INTO tbtest7 (name,comment,time,pass) VALUES (:name, :comment, :time, :pass);");
$sql-> bindParam(':name',$name,PDO::PARAM_STR); //$nameの値を入力
$sql-> bindParam(':comment',$comment,PDO::PARAM_STR); //$commentの値を入力
$sql-> bindParam(':time',$time,PDO::PARAM_STR); //$timeの値を入力
$sql-> bindParam(':pass',$pass,PDO::PARAM_STR); //$passの値を入力
$sql-> execute(); //閉じる
}

//削除
if(!empty($_POST['delete'])){
 //テーブルの表示
$sql = 'select *from tbtest7;';
$results = $pdo->query($sql); //実行

//プラウザで出力
foreach($results as $row){
 if(($row['id'] == $_POST['delete']) && ($row['pass'] == $_POST['pass2'])){
 //削除
 $id = $_POST['delete'];
 $sql2 = "delete from tbtest7 where id='$id';";
 $result = $pdo -> query($sql2);

//auto_incrementを初期化
 $sql = $pdo->prepare("ALTER TABLE tbtest5 AUTO_INCREMENT = 1;"); 
 $sql -> execute(); //閉じる
} else if($row['pass'] != $_POST['pass2']){
 echo "パスワードが違います";
}
}
}

//編集
if(!empty($_POST['edit']) && ($_POST['name']) && ($_POST['text'])){
$sql = 'select *from tbtest7;';
$results = $pdo->query($sql); //実行

//プラウザで出力
foreach($results as $row){
 if(($row['id'] == $_POST['edit']) && ($row['pass'] == $_POST['pass3'])){
//$rowの中身は2-8でどんな中身にしたかで変化する。
 $id = $_POST['edit']; $nm = $_POST['name']; $kome = $_POST['text'];
 $sql = "update tbtest7 set name='$nm', comment='$kome' where id = '$id';";
 $result = $pdo->query($sql);
}
}
}
?>

<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UFT-8">
<title>bbチャンネル</title>
</head>
<body>
<font size="7">bチャンネル</font></br>


<!-名前を保存させる->
<font size="3">・名前</font><br/>
<form action = "" method = "POST">
<input type = "text" name ="user"><br/>

<!-コメントを保存させる->
<font size="3">・コメントを入力してください</font><br/>
<input type="text" name="message"></br>

<font size="3">・パスワードを入力してください</font><br/>
<input type = "text" name ="pass"><br/>
<input type = "submit" value ="送信"><br/><br/>
</form>

<font size="3">-------------------------------------</font><br/>

<form method="post" action="">
<!-削除機能->
<font size="3">・削除する番号を入力してください</font><br/>
<input type = "text" name ="delete"><br/>
<font size="3">・パスワードを入力してください</font><br/>
<input type = "text" name ="pass2"><br/>
<input type = "submit" value ="削除"><br/><br/>
</form>

<font size="3">-------------------------------------</font><br/>

<form method="post" action="">
<!-編集機能->
<font size="3">・編集する番号を入力してください</font><br/>
<input type = "text" name ="edit"><br/>
<!-名前を保存させる->
<font size="3">・名前</font><br/>
<input type = "text" name ="name"><br/>
<!-コメントを保存させる->
<font size="3">・コメントを入力してください</font><br/>
<input type="text" name="text"></br>
<font size="3">・パスワードを入力してください</font><br/>
<input type = "text" name ="pass3"><br/>
<input type = "submit" value ="編集"><br/><br/>
</form>

<font size="3"><hr/></font><br/>

<?php

//テーブルの表示
$sql = 'select *from tbtest7;';
$results = $pdo->query($sql); //実行

//プラウザで出力
foreach($results as $row){
 //$rowの中にはテーブルのカラム名が入る
 echo "投稿時間:". $row['time'].'<br>';
 echo "番号:". $row['id']. '<br>';
 echo "名前:". $row['name']. '<br>';
 echo "コメント:". $row['comment']. '<br>';
 echo "pass:". $row['pass']. '<br>';
 echo '<hr/>';
}
?>
</body>
</html>
